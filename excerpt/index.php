<?php

function fn_excerpt_set($content, $lot) {
    // `excerpt` data has been set or does not have `path` data, skip!
    if ($content || !isset($lot['path'])) {
        return $content; // return the initial value
    }
    global $language;
    extract(Page::open($lot['path'])->get([
        'description' => null,
        'content' => null
    ]));
    $k = Plugin::state(__DIR__, 'cut');
    // excerpt cropper does not exist, return the page’s `description`
    if (!$content || strpos($content, $k) === false) {
        // if page’s `description` is empty, create a fake excerpt generated by the page’s `content`
        return $description ?: To::snippet($content);
    }
    // return the first part!
    return trim(explode($k, $content)[0]);
}

function fn_excerpt_anchor_set($content, $lot) {
    global $site;
    if ($site->is !== 'page') {
        return $content;
    }
    $c = Plugin::state(__DIR__);
    $k = $c['cut'];
    if (strpos($content, $k) === false) {
        return $content;
    }
    return implode('<div class="fi" id="' . __replace__($c['anchor'], ['id' => $lot['id']]) . '"></div>', explode($k, $content, 2));
}

Hook::set('page.excerpt', 'fn_excerpt_set', 2.1);
Hook::set('page.content', 'fn_excerpt_anchor_set', 2.1);